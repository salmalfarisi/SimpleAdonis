"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Validator_1 = global[Symbol.for('ioc.use')]("Adonis/Core/Validator");
const Article_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Article"));
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
class ArticlesController {
    async Index({ request, session, view }) {
        const page = request.input('page', parseInt('1'));
        const limit = parseInt('20');
        const data = await Database_1.default
            .query()
            .from('articles')
            .select('*')
            .where('user_id', session.get('id'))
            .where('delete_status', false)
            .paginate(page, limit);
        data.baseUrl('/article/index');
        return view.render("content.article.index", { data });
    }
    async Create({ view }) {
        const formdata = new Article_1.default();
        return view.render("content.article.form", { formdata });
    }
    async Store({ session, request, response }) {
        const checkschema = Validator_1.schema.create({
            title: Validator_1.schema.string([
                Validator_1.rules.required(),
            ]),
            description: Validator_1.schema.string([
                Validator_1.rules.string(),
            ]),
            image: Validator_1.schema.file({
                required: true,
                size: '2mb',
                extnames: ['jpg', 'png', 'jpeg'],
            }),
        });
        const trx = await Database_1.default.transaction();
        try {
            const payload = await request.validate({
                schema: checkschema
            });
            var settime = new Date();
            var now = settime.getFullYear() + '-' + settime.getMonth() + '-' + settime.getDate() + " " + settime.getHours() + ":" + settime.getMinutes() + ":" + settime.getSeconds();
            const newfile = request.file('image');
            var setname = "article-" + Math.floor(Math.random() * 999999) + "." + newfile.extname;
            const newdata = {
                title: request.input('title'),
                description: request.input('description'),
                user_id: session.get('id'),
                delete_status: false,
                image: setname,
                created_at: now,
            };
            await payload.image.moveToDisk('images', {
                name: setname,
                overwrite: false,
            });
            await trx
                .insertQuery()
                .table('articles')
                .insert(newdata);
            await trx.commit();
            session.flash('success', 'Articles successfully created');
            response.redirect().toRoute('ArticlesController.Index');
        }
        catch (error) {
            await trx.rollback();
            let errors = error.messages;
            console.log(error);
            for (const key in errors) {
                session.flash(key, errors[key]);
            }
            response.redirect().back();
        }
    }
    async Edit({ request, response, view }) {
        const formdata = await Database_1.default
            .from('articles')
            .where('id', request.param('id'))
            .first();
        return view.render("content.article.form", { formdata });
    }
    async Update({ session, request, response }) {
        const checkschema = Validator_1.schema.create({
            title: Validator_1.schema.string([
                Validator_1.rules.required(),
            ]),
            description: Validator_1.schema.string([
                Validator_1.rules.string(),
            ]),
            image: Validator_1.schema.file.optional({
                size: '2mb',
                extnames: ['jpg', 'png', 'jpeg', 'JPG', 'PNG', 'JPEG'],
            }),
        });
        const trx = await Database_1.default.transaction();
        try {
            const payload = await request.validate({
                schema: checkschema
            });
            var settime = new Date();
            var now = settime.getFullYear() + '-' + settime.getMonth() + '-' + settime.getDate() + " " + settime.getHours() + ":" + settime.getMinutes() + ":" + settime.getSeconds();
            const newdata = {
                title: request.input('title'),
                description: request.input('description'),
                updated_at: now,
            };
            const newfile = request.file('image');
            if (newfile != null) {
                var setname = "article-" + Math.floor(Math.random() * 999999) + "." + newfile.extname;
                await payload.image.moveToDisk('images', {
                    name: setname,
                    overwrite: false,
                });
                newdata.image = setname;
            }
            await trx
                .from('articles')
                .where('id', request.param('id'))
                .update(newdata);
            await trx.commit();
            session.flash('success', 'Articles successfully update');
            response.redirect().toRoute('ArticlesController.Index');
        }
        catch (error) {
            await trx.rollback();
            let errors = error.messages;
            console.log(error);
            for (const key in errors) {
                session.flash(key, errors[key]);
            }
            response.redirect().back();
        }
    }
    async Destroy({ request, response }) {
        const trx = await Database_1.default.transaction();
        try {
            var settime = new Date();
            var now = settime.getFullYear() + '-' + settime.getMonth() + '-' + settime.getDate() + " " + settime.getHours() + ":" + settime.getMinutes() + ":" + settime.getSeconds();
            const newdata = {
                delete_status: true,
            };
            await trx
                .from('articles')
                .where('id', request.param('id'))
                .update(newdata);
            await trx.commit();
            session.flash('success', 'Articles successfully delete');
            response.redirect().back();
        }
        catch (error) {
            await trx.rollback();
            let errors = error.messages;
            console.log(error);
            for (const key in errors) {
                session.flash(key, errors[key]);
            }
            response.redirect().back();
        }
    }
}
exports.default = ArticlesController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJ0aWNsZXNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXJ0aWNsZXNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7Ozs7QUFFYiwyRUFBMkQ7QUFDM0QsdUZBQXlDO0FBQ3pDLDJGQUFrRDtBQUdsRCxNQUFxQixrQkFBa0I7SUFDdEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1FBRXJDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QixNQUFNLElBQUksR0FBRyxNQUFNLGtCQUFRO2FBQ3hCLEtBQUssRUFBRTthQUNQLElBQUksQ0FBQyxVQUFVLENBQUM7YUFDaEIsTUFBTSxDQUFDLEdBQUcsQ0FBQzthQUNYLEtBQUssQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNuQyxLQUFLLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQzthQUM3QixRQUFRLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXpCLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUUvQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFO1FBRXBCLE1BQU0sUUFBUSxHQUFHLElBQUksaUJBQU8sRUFBRSxDQUFDO1FBQy9CLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDMUQsQ0FB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QUNmLGFBQWEsRUFBRyxJQUFJO2FBQ3BCLENBQUE7WUFFRCxNQUFNLEdBQUc7aUJBQ04sSUFBSSxDQUFDLFVBQVUsQ0FBQztpQkFDaEIsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNoQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbkIsTUFBTSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7WUFFbkIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsOEJBQThCLENBQUMsQ0FBQztZQUN6RCxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDM0I7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUlmLE1BQU0sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3JCLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7WUFDNUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNuQixLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRTtnQkFDekIsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDaEM7WUFDRCxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDM0I7SUFDRixDQUFDO0NBQ0Q7QUFsTkQscUNBa05DIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5pbXBvcnQgdHlwZSB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0JztcbmltcG9ydCB7IHNjaGVtYSwgcnVsZXMgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL1ZhbGlkYXRvcic7XG5pbXBvcnQgQXJ0aWNsZSBmcm9tICdBcHAvTW9kZWxzL0FydGljbGUnO1xuaW1wb3J0IERhdGFiYXNlIGZyb20gJ0Bpb2M6QWRvbmlzL0x1Y2lkL0RhdGFiYXNlJztcbmltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0FwcGxpY2F0aW9uJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXJ0aWNsZXNDb250cm9sbGVyIHtcblx0YXN5bmMgSW5kZXgoeyByZXF1ZXN0LCBzZXNzaW9uLCB2aWV3IH0pXG5cdHtcblx0XHRjb25zdCBwYWdlID0gcmVxdWVzdC5pbnB1dCgncGFnZScsIHBhcnNlSW50KCcxJykpO1xuXHRcdGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQoJzIwJyk7XG5cdFxuXHRcdGNvbnN0IGRhdGEgPSBhd2FpdCBEYXRhYmFzZVxuXHRcdCAgLnF1ZXJ5KClcblx0XHQgIC5mcm9tKCdhcnRpY2xlcycpXG5cdFx0ICAuc2VsZWN0KCcqJylcblx0XHQgIC53aGVyZSgndXNlcl9pZCcsIHNlc3Npb24uZ2V0KCdpZCcpKVxuXHRcdCAgLndoZXJlKCdkZWxldGVfc3RhdHVzJywgZmFsc2UpXG5cdFx0ICAucGFnaW5hdGUocGFnZSwgbGltaXQpO1xuXHRcdCAgXG5cdFx0ZGF0YS5iYXNlVXJsKCcvYXJ0aWNsZS9pbmRleCcpO1xuXHRcdFxuXHRcdHJldHVybiB2aWV3LnJlbmRlcihcImNvbnRlbnQuYXJ0aWNsZS5pbmRleFwiLCB7IGRhdGEgfSk7XG5cdH1cblx0XG5cdGFzeW5jIENyZWF0ZSh7IHZpZXcgfSlcblx0e1xuXHRcdGNvbnN0IGZvcm1kYXRhID0gbmV3IEFydGljbGUoKTtcblx0XHRyZXR1cm4gdmlldy5yZW5kZXIoXCJjb250ZW50LmFydGljbGUuZm9ybVwiLCB7IGZvcm1kYXRhIH0pO1xuXHR9XG5cdFxuXHRhc3luYyBTdG9yZSh7IHNlc3Npb24sIHJlcXVlc3QsIHJlc3BvbnNlIH0pXG5cdHtcblx0XHRjb25zdCBjaGVja3NjaGVtYSA9IHNjaGVtYS5jcmVhdGUoe1xuXHRcdFx0dGl0bGU6IHNjaGVtYS5zdHJpbmcoW1xuXHRcdFx0XHRydWxlcy5yZXF1aXJlZCgpLFxuXHRcdFx0XSksXG5cdFx0XHRkZXNjcmlwdGlvbjogc2NoZW1hLnN0cmluZyhbXG5cdFx0XHRcdHJ1bGVzLnN0cmluZygpLFxuXHRcdFx0XSksXG5cdFx0XHRpbWFnZTogc2NoZW1hLmZpbGUoe1xuXHRcdFx0XHRyZXF1aXJlZDp0cnVlLFxuXHRcdFx0XHRzaXplOicybWInLFxuXHRcdFx0XHRleHRuYW1lczogWydqcGcnLCAncG5nJywgJ2pwZWcnXSxcblx0XHRcdH0pLFxuXHRcdH0pXG5cdFxuXHRcdGNvbnN0IHRyeCA9IGF3YWl0IERhdGFiYXNlLnRyYW5zYWN0aW9uKCk7XG5cdFx0dHJ5IHtcblx0XHRcdC8qKlxuXHRcdFx0ICogU3RlcCAyIC0gVmFsaWRhdGUgcmVxdWVzdCBib2R5IGFnYWluc3Rcblx0XHRcdCAqICAgICAgICAgIHRoZSBzY2hlbWFcblx0XHRcdCAqL1xuXHRcdFx0IFxuXHRcdFx0Y29uc3QgcGF5bG9hZCA9IGF3YWl0IHJlcXVlc3QudmFsaWRhdGUoe1xuXHRcdFx0ICBzY2hlbWE6IGNoZWNrc2NoZW1hXG5cdFx0XHR9KTtcblx0XHRcdFxuXHRcdFx0dmFyIHNldHRpbWUgPSBuZXcgRGF0ZSgpO1xuXHRcdFx0dmFyIG5vdyA9IHNldHRpbWUuZ2V0RnVsbFllYXIoKSArICctJyArIHNldHRpbWUuZ2V0TW9udGgoKSArICctJyArIHNldHRpbWUuZ2V0RGF0ZSgpICsgXCIgXCIgKyBzZXR0aW1lLmdldEhvdXJzKCkgKyBcIjpcIiArIHNldHRpbWUuZ2V0TWludXRlcygpICsgXCI6XCIgKyBzZXR0aW1lLmdldFNlY29uZHMoKTtcblx0XHRcdFxuXHRcdFx0Y29uc3QgbmV3ZmlsZSA9IHJlcXVlc3QuZmlsZSgnaW1hZ2UnKTtcblx0XHRcdHZhciBzZXRuYW1lID0gXCJhcnRpY2xlLVwiICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogOTk5OTk5KSArIFwiLlwiICsgbmV3ZmlsZS5leHRuYW1lO1x0XHRcdFxuXHRcdFx0XG5cdFx0XHRjb25zdCBuZXdkYXRhID0ge1xuXHRcdFx0XHR0aXRsZSA6IHJlcXVlc3QuaW5wdXQoJ3RpdGxlJyksXG5cdFx0XHRcdGRlc2NyaXB0aW9uIDogcmVxdWVzdC5pbnB1dCgnZGVzY3JpcHRpb24nKSxcblx0XHRcdFx0dXNlcl9pZCA6IHNlc3Npb24uZ2V0KCdpZCcpLFxuXHRcdFx0XHRkZWxldGVfc3RhdHVzIDogZmFsc2UsXG5cdFx0XHRcdGltYWdlOiBzZXRuYW1lLFxuXHRcdFx0XHRjcmVhdGVkX2F0IDogbm93LFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRhd2FpdCBwYXlsb2FkLmltYWdlLm1vdmVUb0Rpc2soJ2ltYWdlcycsIHtcblx0XHRcdCAgbmFtZTogc2V0bmFtZSxcblx0XHRcdCAgb3ZlcndyaXRlOiBmYWxzZSwgLy8gb3ZlcndyaXRlIGluIGNhc2Ugb2YgY29uZmxpY3Rcblx0XHRcdH0pXG5cdFx0XHRcblx0XHRcdGF3YWl0IHRyeFxuXHRcdFx0ICAuaW5zZXJ0UXVlcnkoKVxuXHRcdFx0ICAudGFibGUoJ2FydGljbGVzJylcblx0XHRcdCAgLmluc2VydChuZXdkYXRhKTtcblx0XHRcdFxuXHRcdFx0YXdhaXQgdHJ4LmNvbW1pdCgpO1xuXHRcdFx0XG5cdFx0XHRzZXNzaW9uLmZsYXNoKCdzdWNjZXNzJywgJ0FydGljbGVzIHN1Y2Nlc3NmdWxseSBjcmVhdGVkJyk7XG5cdFx0XHRyZXNwb25zZS5yZWRpcmVjdCgpLnRvUm91dGUoJ0FydGljbGVzQ29udHJvbGxlci5JbmRleCcpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHQvKipcblx0XHRcdCAqIFN0ZXAgMyAtIEhhbmRsZSBlcnJvcnNcblx0XHRcdCAqL1xuXHRcdFx0YXdhaXQgdHJ4LnJvbGxiYWNrKCk7XG5cdFx0XHRsZXQgZXJyb3JzID0gZXJyb3IubWVzc2FnZXM7XG5cdFx0XHRjb25zb2xlLmxvZyhlcnJvcik7XG5cdFx0XHRmb3IgKGNvbnN0IGtleSBpbiBlcnJvcnMpIHtcblx0XHRcdFx0c2Vzc2lvbi5mbGFzaChrZXksIGVycm9yc1trZXldKTtcblx0XHRcdH1cblx0XHRcdHJlc3BvbnNlLnJlZGlyZWN0KCkuYmFjaygpO1xuXHRcdH1cblx0fVxuXHRcblx0YXN5bmMgRWRpdCh7IHJlcXVlc3QsIHJlc3BvbnNlLCB2aWV3IH0pXG5cdHtcblx0XHRjb25zdCBmb3JtZGF0YSA9IGF3YWl0IERhdGFiYXNlXG5cdFx0XHQuZnJvbSgnYXJ0aWNsZXMnKVxuXHRcdFx0LndoZXJlKCdpZCcsIHJlcXVlc3QucGFyYW0oJ2lkJykpXG5cdFx0XHQuZmlyc3QoKTtcblx0XHRcdFxuXHRcdHJldHVybiB2aWV3LnJlbmRlcihcImNvbnRlbnQuYXJ0aWNsZS5mb3JtXCIsIHsgZm9ybWRhdGEgfSk7XG5cdH1cblx0XG5cdGFzeW5jIFVwZGF0ZSh7IHNlc3Npb24sIHJlcXVlc3QsIHJlc3BvbnNlIH0pXG5cdHtcblx0XHRjb25zdCBjaGVja3NjaGVtYSA9IHNjaGVtYS5jcmVhdGUoe1xuXHRcdFx0dGl0bGU6IHNjaGVtYS5zdHJpbmcoW1xuXHRcdFx0XHRydWxlcy5yZXF1aXJlZCgpLFxuXHRcdFx0XSksXG5cdFx0XHRkZXNjcmlwdGlvbjogc2NoZW1hLnN0cmluZyhbXG5cdFx0XHRcdHJ1bGVzLnN0cmluZygpLFxuXHRcdFx0XSksXG5cdFx0XHRpbWFnZTogc2NoZW1hLmZpbGUub3B0aW9uYWwoe1xuXHRcdFx0XHRzaXplOicybWInLFxuXHRcdFx0XHRleHRuYW1lczogWydqcGcnLCAncG5nJywgJ2pwZWcnLCAnSlBHJywgJ1BORycsICdKUEVHJ10sXG5cdFx0XHR9KSxcblx0XHR9KVxuXHRcblx0XHRjb25zdCB0cnggPSBhd2FpdCBEYXRhYmFzZS50cmFuc2FjdGlvbigpO1xuXHRcdHRyeSB7XG5cdFx0XHQvKipcblx0XHRcdCAqIFN0ZXAgMiAtIFZhbGlkYXRlIHJlcXVlc3QgYm9keSBhZ2FpbnN0XG5cdFx0XHQgKiAgICAgICAgICB0aGUgc2NoZW1hXG5cdFx0XHQgKi9cblx0XHRcdGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKHtcblx0XHRcdCAgc2NoZW1hOiBjaGVja3NjaGVtYVxuXHRcdFx0fSk7XG5cdFx0XHRcblx0XHRcdHZhciBzZXR0aW1lID0gbmV3IERhdGUoKTtcblx0XHRcdHZhciBub3cgPSBzZXR0aW1lLmdldEZ1bGxZZWFyKCkgKyAnLScgKyBzZXR0aW1lLmdldE1vbnRoKCkgKyAnLScgKyBzZXR0aW1lLmdldERhdGUoKSArIFwiIFwiICsgc2V0dGltZS5nZXRIb3VycygpICsgXCI6XCIgKyBzZXR0aW1lLmdldE1pbnV0ZXMoKSArIFwiOlwiICsgc2V0dGltZS5nZXRTZWNvbmRzKCk7XG5cdFx0XHRcblx0XHRcdGNvbnN0IG5ld2RhdGEgPSB7XG5cdFx0XHRcdHRpdGxlIDogcmVxdWVzdC5pbnB1dCgndGl0bGUnKSxcblx0XHRcdFx0ZGVzY3JpcHRpb24gOiByZXF1ZXN0LmlucHV0KCdkZXNjcmlwdGlvbicpLFxuXHRcdFx0XHR1cGRhdGVkX2F0IDogbm93LFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRjb25zdCBuZXdmaWxlID0gcmVxdWVzdC5maWxlKCdpbWFnZScpO1xuXHRcdFx0aWYobmV3ZmlsZSAhPSBudWxsKVxuXHRcdFx0e1xuXHRcdFx0XHR2YXIgc2V0bmFtZSA9IFwiYXJ0aWNsZS1cIiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDk5OTk5OSkgKyBcIi5cIiArIG5ld2ZpbGUuZXh0bmFtZTtcblx0XHRcdFx0YXdhaXQgcGF5bG9hZC5pbWFnZS5tb3ZlVG9EaXNrKCdpbWFnZXMnLCB7XG5cdFx0XHRcdCAgbmFtZTogc2V0bmFtZSxcblx0XHRcdFx0ICBvdmVyd3JpdGU6IGZhbHNlLCAvLyBvdmVyd3JpdGUgaW4gY2FzZSBvZiBjb25mbGljdFxuXHRcdFx0XHR9KVxuXHRcdFx0XHRuZXdkYXRhLmltYWdlID0gc2V0bmFtZTtcblx0XHRcdH1cdFx0XHRcblx0XHRcdFxuXHRcdFx0YXdhaXQgdHJ4XG5cdFx0XHQgIC5mcm9tKCdhcnRpY2xlcycpXG5cdFx0XHQgIC53aGVyZSgnaWQnLCByZXF1ZXN0LnBhcmFtKCdpZCcpKVxuXHRcdFx0ICAudXBkYXRlKG5ld2RhdGEpO1xuXHRcdFx0XG5cdFx0XHRhd2FpdCB0cnguY29tbWl0KCk7XG5cdFx0XHRcblx0XHRcdHNlc3Npb24uZmxhc2goJ3N1Y2Nlc3MnLCAnQXJ0aWNsZXMgc3VjY2Vzc2Z1bGx5IHVwZGF0ZScpO1xuXHRcdFx0cmVzcG9uc2UucmVkaXJlY3QoKS50b1JvdXRlKCdBcnRpY2xlc0NvbnRyb2xsZXIuSW5kZXgnKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0LyoqXG5cdFx0XHQgKiBTdGVwIDMgLSBIYW5kbGUgZXJyb3JzXG5cdFx0XHQgKi9cblx0XHRcdGF3YWl0IHRyeC5yb2xsYmFjaygpO1xuXHRcdFx0bGV0IGVycm9ycyA9IGVycm9yLm1lc3NhZ2VzO1xuXHRcdFx0Y29uc29sZS5sb2coZXJyb3IpO1xuXHRcdFx0Zm9yIChjb25zdCBrZXkgaW4gZXJyb3JzKSB7XG5cdFx0XHRcdHNlc3Npb24uZmxhc2goa2V5LCBlcnJvcnNba2V5XSk7XG5cdFx0XHR9XG5cdFx0XHRyZXNwb25zZS5yZWRpcmVjdCgpLmJhY2soKTtcblx0XHR9XG5cdH1cblx0XG5cdGFzeW5jIERlc3Ryb3koeyByZXF1ZXN0LCByZXNwb25zZSB9KVxuXHR7XG5cdFx0Y29uc3QgdHJ4ID0gYXdhaXQgRGF0YWJhc2UudHJhbnNhY3Rpb24oKTtcblx0XHR0cnkge1xuXHRcdFx0LyoqXG5cdFx0XHQgKiBTdGVwIDIgLSBWYWxpZGF0ZSByZXF1ZXN0IGJvZHkgYWdhaW5zdFxuXHRcdFx0ICogICAgICAgICAgdGhlIHNjaGVtYVxuXHRcdFx0ICovXG5cdFx0XHR2YXIgc2V0dGltZSA9IG5ldyBEYXRlKCk7XG5cdFx0XHR2YXIgbm93ID0gc2V0dGltZS5nZXRGdWxsWWVhcigpICsgJy0nICsgc2V0dGltZS5nZXRNb250aCgpICsgJy0nICsgc2V0dGltZS5nZXREYXRlKCkgKyBcIiBcIiArIHNldHRpbWUuZ2V0SG91cnMoKSArIFwiOlwiICsgc2V0dGltZS5nZXRNaW51dGVzKCkgKyBcIjpcIiArIHNldHRpbWUuZ2V0U2Vjb25kcygpO1xuXHRcdFx0XG5cdFx0XHRjb25zdCBuZXdkYXRhID0ge1xuXHRcdFx0XHRkZWxldGVfc3RhdHVzIDogdHJ1ZSxcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0YXdhaXQgdHJ4XG5cdFx0XHQgIC5mcm9tKCdhcnRpY2xlcycpXG5cdFx0XHQgIC53aGVyZSgnaWQnLCByZXF1ZXN0LnBhcmFtKCdpZCcpKVxuXHRcdFx0ICAudXBkYXRlKG5ld2RhdGEpO1xuXHRcdFx0XG5cdFx0XHRhd2FpdCB0cnguY29tbWl0KCk7XG5cdFx0XHRcblx0XHRcdHNlc3Npb24uZmxhc2goJ3N1Y2Nlc3MnLCAnQXJ0aWNsZXMgc3VjY2Vzc2Z1bGx5IGRlbGV0ZScpO1xuXHRcdFx0cmVzcG9uc2UucmVkaXJlY3QoKS5iYWNrKCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdC8qKlxuXHRcdFx0ICogU3RlcCAzIC0gSGFuZGxlIGVycm9yc1xuXHRcdFx0ICovXG5cdFx0XHRhd2FpdCB0cngucm9sbGJhY2soKTtcblx0XHRcdGxldCBlcnJvcnMgPSBlcnJvci5tZXNzYWdlcztcblx0XHRcdGNvbnNvbGUubG9nKGVycm9yKTtcblx0XHRcdGZvciAoY29uc3Qga2V5IGluIGVycm9ycykge1xuXHRcdFx0XHRzZXNzaW9uLmZsYXNoKGtleSwgZXJyb3JzW2tleV0pO1xuXHRcdFx0fVxuXHRcdFx0cmVzcG9uc2UucmVkaXJlY3QoKS5iYWNrKCk7XG5cdFx0fVxuXHR9XG59XG4iXX0=